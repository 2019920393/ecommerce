# UC9 & UC10 场景建模完整文档
## 云原生微服务电商平台 - 场景建模

**项目名称**：云原生微服务电商平台  
**用例编号**：UC9（创建订单）、UC10（订单支付）  
**文档版本**：V1.0  
**编写日期**：2025-11-04

---

## UC9：创建订单 - 场景建模

### 第一步：用例故事

#### 用例名称：创建订单

**用例故事描述**：

如果我已经登录系统并在购物车中添加了想要购买的商品，那么我可以从购物车页面选择一个或多个商品进行结算。点击"去结算"按钮后，系统会自动跳转到订单确认页面。

在订单确认页面，我需要首先选择收货地址。如果我之前已经保存过地址，可以从地址列表中选择一个；如果没有或想使用新地址，可以点击"新增收货地址"，填写收货人姓名（最长20字符）、联系电话（11位手机号）、省市区（通过下拉框选择）和详细地址（最长100字符），填写完成后可以选择是否设为默认地址。

选择好收货地址后，我可以查看本次订单的商品清单。每个商品会显示商品名称、规格（如颜色、尺码）、数量、单价和小计金额。我可以在此页面修改商品数量，系统会实时重新计算金额。

页面下方会显示订单金额汇总，包括商品总价（所有商品小计之和）、运费（根据地址和重量计算，满99元免运费）和优惠金额（如果有可用的优惠券）。最终的订单总金额会以醒目的方式展示。

在我点击"提交订单"之前，系统会进行实时库存校验。如果任何一个商品库存不足，系统会立即弹出提示"商品[商品名]库存不足，当前库存[数量]件"，并阻止订单提交。只有所有商品库存充足时，订单才能成功提交。

订单提交成功后，系统会生成一个唯一的18位订单号（格式：ORD+13位时间戳+5位随机数），订单状态设置为"待支付"。同时，系统会预扣商品库存（锁定库存但不实际扣减），并设置30分钟的支付超时时间。如果30分钟内未支付，订单会自动取消，库存也会自动释放。

创建成功后，我会被自动跳转到支付页面，也可以选择稍后在"我的订单"中找到待支付订单进行支付。

#### 用例故事需要回答的问题：

1. **主要参与者和次要参与者是谁？**
   - 主要参与者：已登录的普通用户（买家）
   - 次要参与者：订单服务、库存服务、购物车服务

2. **参与者目标是什么？**
   - 用户目标：将购物车中的商品转化为订单，准备支付购买
   - 系统目标：创建订单记录，锁定库存，确保交易流程顺利进行

3. **故事开始前有什么前提条件？**
   - 用户已登录系统
   - 用户购物车中有至少一个商品
   - 选中的商品库存充足
   - 用户至少有一个有效的收货地址（或准备新增）

4. **参与者完成的主要工作和功能是什么？**
   - 选择购物车中的商品
   - 选择或新增收货地址
   - 确认商品清单和数量
   - 查看订单金额（商品总价+运费-优惠）
   - 提交订单

5. **按故事所描述的还需考虑什么异常？**
   - 商品库存不足
   - 收货地址信息不完整或格式错误
   - 网络超时导致订单提交失败
   - 商品已下架或删除
   - 用户在提交过程中退出登录

6. **参与者的交互中可能有什么变化？**
   - 用户可能修改商品数量
   - 用户可能切换收货地址
   - 用户可能使用优惠券改变订单金额
   - 用户可能取消订单创建返回购物车

7. **参与者将获得、产生或改变哪些系统信息？**
   - 产生：订单记录、订单号、订单明细记录
   - 改变：库存状态（预扣）、购物车状态（保持不变，待支付成功后清空）
   - 获得：订单确认信息、订单号、支付倒计时

8. **参与者必须通知系统外部环境的改变吗？**
   - 需要通知库存服务进行库存锁定
   - 需要记录订单创建日志
   - 订单创建成功后可能需要发送短信/邮件通知用户

9. **参与者希望从系统中获取什么信息？**
   - 订单详情（订单号、商品清单、金额、收货地址）
   - 支付超时时间（30分钟倒计时）
   - 库存是否充足的实时反馈

10. **参与者希望得知意料之外的变更吗？**
    - 库存不足时的及时提醒
    - 商品价格变动的提示
    - 订单提交失败的原因说明

---

### 第二步：用例步骤（包含活动图）

#### UC9 创建订单 - 详细步骤

**前置条件**：
- 用户已登录
- 购物车中有商品
- 商品库存充足

**主成功场景**：

1. 用户在购物车页面选择一个或多个商品
2. 用户点击"去结算"按钮
3. 系统显示订单确认页面
4. 用户选择收货地址
   - 4a. 如果没有地址，用户点击"新增地址"
   - 4b. 用户填写收货人、电话、省市区、详细地址
   - 4c. 用户选择是否设为默认地址
   - 4d. 系统保存地址信息
5. 系统显示商品清单（名称、规格、数量、单价、小计）
6. 用户确认或修改商品数量
7. 系统实时计算订单金额（商品总价+运费-优惠）
8. 用户点击"提交订单"
9. 系统校验所有商品库存
10. 系统创建订单记录
11. 系统生成18位唯一订单号
12. 系统设置订单状态为"待支付"
13. 系统调用库存服务预扣库存
14. 系统设置30分钟支付超时时间
15. 系统显示订单创建成功页面
16. 系统跳转到支付页面

**扩展场景**：

**9a. 库存不足**：
- 9a1. 系统检测到某商品库存不足
- 9a2. 系统显示提示"商品[名称]库存不足，当前库存[数量]件"
- 9a3. 系统阻止订单提交
- 9a4. 用户返回购物车修改数量或删除商品

**8a. 收货地址未选择**：
- 8a1. 系统检测到未选择收货地址
- 8a2. 系统提示"请选择收货地址"
- 8a3. 用户返回选择或新增地址

**6a. 商品价格变动**：
- 6a1. 系统检测到商品价格已变动
- 6a2. 系统提示"商品[名称]价格已变动"
- 6a3. 系统显示新价格
- 6a4. 用户确认或取消订单

**13a. 库存预扣失败**：
- 13a1. 库存服务返回预扣失败
- 13a2. 系统回滚订单记录
- 13a3. 系统提示"订单创建失败，请重试"

**后置条件**：
- 订单记录已创建
- 库存已锁定
- 订单状态为"待支付"
- 用户进入支付页面

#### UC9 活动图

```
[开始]
  ↓
[用户选择购物车商品]
  ↓
[点击"去结算"]
  ↓
[显示订单确认页面]
  ↓
<是否有收货地址？>
  ├─ 是 → [选择已有地址]
  └─ 否 → [新增收货地址] → [填写地址信息] → [保存地址]
  ↓
[显示商品清单]
  ↓
<用户是否修改数量？>
  ├─ 是 → [修改数量] → [重新计算金额] ──┐
  └─ 否 ─────────────────────────────────┘
  ↓
[显示订单金额汇总]
  ↓
[用户点击"提交订单"]
  ↓
[校验商品库存]
  ↓
<库存是否充足？>
  ├─ 否 → [显示库存不足提示] → [返回购物车]
  └─ 是 ↓
[创建订单记录]
  ↓
[生成订单号]
  ↓
[设置状态为"待支付"]
  ↓
[调用库存服务预扣库存]
  ↓
<预扣是否成功？>
  ├─ 否 → [回滚订单] → [显示失败提示] → [结束]
  └─ 是 ↓
[设置30分钟超时时间]
  ↓
[显示订单创建成功]
  ↓
[跳转到支付页面]
  ↓
[结束]
```

---

### 第三步：用例模板

**用例ID**：UC9  
**用例名称**：创建订单  
**创建日期**：2025-11-04  
**最后更新**：2025-11-04  
**版本**：V1.0

**参与者**：
- 主要参与者：已登录用户（买家）
- 次要参与者：订单服务、库存服务、购物车服务

**触发器**：
- 用户在购物车页面点击"去结算"按钮

**前置条件**：
- PR-1：用户已成功登录系统
- PR-2：用户购物车中至少有一个商品
- PR-3：选中的商品库存充足
- PR-4：用户至少有一个有效的收货地址或准备新增地址

**后置条件**：
- 成功：
  - PO-1：订单记录已创建并保存到数据库
  - PO-2：生成唯一的18位订单号
  - PO-3：订单状态设置为"待支付"
  - PO-4：商品库存已预扣（锁定）
  - PO-5：设置30分钟支付超时时间
  - PO-6：用户跳转到支付页面
- 失败：
  - PO-F1：订单未创建
  - PO-F2：库存未改变
  - PO-F3：用户收到错误提示

**主成功场景**：
1. 用户在购物车页面选择一个或多个商品
2. 用户点击"去结算"按钮
3. 系统显示订单确认页面
4. 用户选择收货地址（或新增地址）
5. 系统显示商品清单
6. 用户确认商品信息和数量
7. 系统显示订单金额汇总
8. 用户点击"提交订单"
9. 系统校验商品库存
10. 系统创建订单并预扣库存
11. 系统显示订单创建成功
12. 系统跳转到支付页面

**扩展场景**：
- 4a：用户新增收货地址
  - 填写收货人、电话、省市区、详细地址
  - 系统保存地址信息
- 6a：用户修改商品数量
  - 系统重新计算金额
- 9a：库存不足
  - 系统提示库存不足
  - 阻止订单提交
- 13a：库存预扣失败
  - 系统回滚订单记录
  - 显示失败提示

**特殊需求**：
- NFR-1：订单号必须全局唯一（18位：ORD+时间戳+随机数）
- NFR-2：库存校验和预扣必须是原子操作
- NFR-3：订单创建响应时间不超过2秒
- NFR-4：支持并发1000用户同时创建订单
- NFR-5：库存预扣使用乐观锁机制
- NFR-6：订单数据必须持久化存储

**技术和数据变化列表**：
- 创建订单记录（Order表）
- 创建订单明细记录（OrderItem表）
- 更新库存锁定数量（Inventory表）
- 记录库存锁定日志（InventoryLock表）

**发生频率**：
- 高频用例，预计每天1000-5000次

**未决问题**：
- Q1：如何处理高并发情况下的库存超卖？
  - A1：使用乐观锁+库存预扣机制
- Q2：订单超时未支付如何处理？
  - A2：定时任务每分钟扫描超时订单，自动取消并释放库存

---

## UC10：订单支付 - 场景建模

### 第一步：用例故事

#### 用例名称：订单支付

**用例故事描述**：

如果我已经成功创建了一个订单，那么我可以选择立即支付或者稍后在"我的订单"页面找到这个待支付订单。当我点击"去支付"按钮后，系统会创建一个支付订单并生成唯一的20位支付流水号（格式：PAY+13位时间戳+6位随机数）。

在支付页面，我可以清楚地看到订单金额（精确到0.01元）、订单号、支付剩余时间（倒计时显示）。系统提供多种支付方式供我选择：支付宝、微信支付、银行卡支付。由于这是课程作业，系统使用模拟支付方式，我只需选择一种支付方式并点击"确认支付"。

点击"确认支付"后，系统会模拟支付过程（90%成功率，10%失败率），并在2-3秒后返回支付结果。如果支付成功，系统会执行一系列操作：首先更新订单状态从"待支付"变为"待发货"，然后实际扣减商品库存（将预扣库存转为实际扣减），清空我购物车中已下单的商品，生成支付记录（包含支付流水号、支付时间、支付金额、支付方式），并触发发货通知。支付成功后，我会看到支付成功页面，显示支付流水号和订单详情。

如果支付失败，系统会回滚之前预扣的库存，订单状态变为"已取消"，我会看到支付失败页面并提示失败原因（如"余额不足"、"支付超时"等）。我可以选择重新支付或取消订单。

如果我在30分钟内未完成支付，系统会自动取消订单，释放预扣的库存，订单状态变为"已取消"。系统会发送通知提醒我"订单已超时取消"。

支付过程中的所有操作都会被记录到支付记录表中，包括支付成功、支付失败、支付超时等状态，用于后续的对账和审计。

#### 用例故事需要回答的问题：

1. **主要参与者和次要参与者是谁？**
   - 主要参与者：已登录的普通用户（买家）
   - 次要参与者：支付服务、订单服务、库存服务、购物车服务、通知服务、支付网关（模拟）

2. **参与者目标是什么？**
   - 用户目标：完成订单支付，购买商品
   - 系统目标：处理支付流程，更新订单状态，扣减库存，确保数据一致性

3. **故事开始前有什么前提条件？**
   - 用户已登录系统
   - 存在状态为"待支付"的订单
   - 订单未超时（30分钟内）
   - 商品库存已预扣

4. **参与者完成的主要工作和功能是什么？**
   - 选择支付方式
   - 确认支付金额
   - 执行支付操作
   - 查看支付结果

5. **按故事所描述的还需考虑什么异常？**
   - 支付失败（余额不足、网络超时等）
   - 支付超时（30分钟）
   - 重复支付
   - 订单已取消
   - 订单已支付

6. **参与者的交互中可能有什么变化？**
   - 用户可能切换支付方式
   - 用户可能取消支付返回订单列表
   - 用户可能在支付过程中离开页面
   - 用户可能尝试重新支付失败的订单

7. **参与者将获得、产生或改变哪些系统信息？**
   - 产生：支付订单记录、支付流水号、支付记录
   - 改变：订单状态（待支付→待发货或已取消）、库存数量（预扣→实际扣减或释放）、购物车状态（清空）
   - 获得：支付结果、支付流水号、支付时间

8. **参与者必须通知系统外部环境的改变吗？**
   - 需要调用支付网关处理支付（模拟）
   - 支付成功后需要触发发货通知
   - 需要发送支付结果通知（短信/邮件）
   - 需要记录支付日志

9. **参与者希望从系统中获取什么信息？**
   - 支付结果（成功/失败）
   - 支付流水号
   - 订单状态
   - 支付剩余时间

10. **参与者希望得知意料之外的变更吗？**
    - 支付失败的具体原因
    - 订单超时自动取消的通知
    - 库存不足导致的支付失败

---

### 第二步：用例步骤（包含活动图）

#### UC10 订单支付 - 详细步骤

**前置条件**：
- 用户已登录
- 存在状态为"待支付"的订单
- 订单未超时
- 库存已预扣

**主成功场景**：

1. 用户在订单详情页点击"去支付"按钮
2. 系统创建支付订单
3. 系统生成20位支付流水号
4. 系统显示支付页面（订单金额、订单号、倒计时）
5. 用户选择支付方式（支付宝/微信/银行卡/模拟）
6. 用户点击"确认支付"
7. 系统调用支付服务处理支付
8. 系统模拟支付处理（2-3秒）
9. 支付成功，系统接收支付回调
10. 系统更新订单状态为"待发货"
11. 系统调用库存服务实际扣减库存
12. 系统调用购物车服务清空已下单商品
13. 系统生成支付记录
14. 系统触发发货通知
15. 系统显示支付成功页面
16. 用户查看支付流水号和订单详情

**扩展场景**：

**9a. 支付失败**：
- 9a1. 系统接收支付失败回调
- 9a2. 系统更新支付订单状态为"失败"
- 9a3. 系统显示支付失败页面和原因
- 9a4. 用户选择重新支付或取消订单

**9b. 支付超时（30分钟）**：
- 9b1. 系统定时任务检测到订单超时
- 9b2. 系统自动取消订单
- 9b3. 系统调用库存服务释放预扣库存
- 9b4. 系统更新订单状态为"已取消"
- 9b5. 系统发送超时取消通知

**11a. 库存扣减失败**：
- 11a1. 库存服务返回扣减失败
- 11a2. 系统标记订单为异常状态
- 11a3. 系统发送异常通知给管理员
- 11a4. 系统尝试补偿操作或人工处理

**7a. 重复支付**：
- 7a1. 系统检测到订单已支付
- 7a2. 系统提示"订单已支付，请勿重复支付"
- 7a3. 系统跳转到订单详情页

**后置条件**：
- 成功：
  - 订单状态为"待发货"
  - 库存已实际扣减
  - 购物车已清空
  - 支付记录已生成
- 失败：
  - 订单状态为"已取消"
  - 库存已释放
  - 支付记录记录失败原因

#### UC10 活动图

```
[开始]
  ↓
[用户点击"去支付"]
  ↓
<订单是否有效？>
  ├─ 否（已支付/已取消/已超时） → [显示提示] → [结束]
  └─ 是 ↓
[创建支付订单]
  ↓
[生成支付流水号]
  ↓
[显示支付页面]
  ↓
[用户选择支付方式]
  ↓
[用户点击"确认支付"]
  ↓
[调用支付服务]
  ↓
[模拟支付处理(2-3秒)]
  ↓
<支付是否成功？>
  ├─ 否 → [支付失败处理] ──────────┐
  │         ↓                        │
  │    [显示失败原因]                 │
  │         ↓                        │
  │    <用户选择>                     │
  │    ├─ 重新支付 → [返回支付页面]  │
  │    └─ 取消订单 ──────────────────┤
  │                                  │
  └─ 是 → [支付成功处理] ──┐         │
            ↓              │         │
       [更新订单状态]      │         │
            ↓              │         │
       [实际扣减库存]      │         │
            ↓              │         │
       <扣减是否成功？>    │         │
       ├─ 否 → [异常处理] │         │
       └─ 是 ↓            │         │
       [清空购物车]        │         │
            ↓              │         │
       [生成支付记录]      │         │
            ↓              │         │
       [触发发货通知]      │         │
            ↓              │         │
       [显示支付成功页面]  │         │
            ↓              │         │
       [显示流水号和详情]  │         │
            └──────────────┴─────────┘
                    ↓
                 [结束]

[定时任务：检查超时订单]
  ↓
<是否有超时订单？>
  ├─ 否 → [结束]
  └─ 是 ↓
[取消订单]
  ↓
[释放库存]
  ↓
[发送超时通知]
  ↓
[结束]
```

---

### 第三步：用例模板

**用例ID**：UC10  
**用例名称**：订单支付  
**创建日期**：2025-11-04  
**最后更新**：2025-11-04  
**版本**：V1.0

**参与者**：
- 主要参与者：已登录用户（买家）
- 次要参与者：支付服务、订单服务、库存服务、购物车服务、通知服务、支付网关（模拟）

**触发器**：
- 用户在订单详情页点击"去支付"按钮

**前置条件**：
- PR-1：用户已成功登录系统
- PR-2：存在状态为"待支付"的订单
- PR-3：订单未超时（创建后30分钟内）
- PR-4：商品库存已预扣

**后置条件**：
- 成功：
  - PO-1：订单状态更新为"待发货"
  - PO-2：商品库存已实际扣减
  - PO-3：用户购物车已清空已下单商品
  - PO-4：生成支付记录
  - PO-5：触发发货通知
  - PO-6：用户查看支付成功页面
- 失败：
  - PO-F1：订单状态为"已取消"
  - PO-F2：库存已释放
  - PO-F3：用户收到失败提示
  - PO-F4：支付记录记录失败原因

**主成功场景**：
1. 用户点击"去支付"按钮
2. 系统创建支付订单并生成流水号
3. 系统显示支付页面
4. 用户选择支付方式
5. 用户确认支付
6. 系统处理支付（模拟）
7. 支付成功
8. 系统更新订单状态
9. 系统扣减库存
10. 系统清空购物车
11. 系统生成支付记录
12. 系统显示支付成功页面

**扩展场景**：
- 7a：支付失败
  - 显示失败原因
  - 用户选择重新支付或取消
- 9a：库存扣减失败
  - 标记订单异常
  - 通知管理员处理
- 定时任务：订单超时
  - 自动取消订单
  - 释放库存
  - 发送通知

**特殊需求**：
- NFR-1：支付流水号必须全局唯一（20位）
- NFR-2：支付处理必须支持分布式事务
- NFR-3：支付成功后的操作必须保证最终一致性
- NFR-4：支付响应时间不超过3秒
- NFR-5：支持并发500用户同时支付
- NFR-6：支付数据必须持久化存储
- NFR-7：模拟支付成功率90%

**技术和数据变化列表**：
- 创建支付订单记录（PaymentOrder表）
- 创建支付记录（PaymentRecord表）
- 更新订单状态（Order表）
- 扣减商品库存（Inventory表）
- 删除库存锁定记录（InventoryLock表）
- 清空购物车商品（CartItem表）

**发生频率**：
- 高频用例，预计每天500-3000次

**未决问题**：
- Q1：如何保证支付成功后的一系列操作的原子性？
  - A1：使用Seata AT模式或消息队列实现最终一致性
- Q2：如何处理支付成功但库存扣减失败的情况？
  - A2：使用补偿机制，人工介入处理异常订单

---

**文档结束**



