# UC9 & UC10 ç±»çš„ç²¾åŒ–è®¾è®¡æ–‡æ¡£
## äº‘åŸç”Ÿå¾®æœåŠ¡ç”µå•†å¹³å° - åŸºäºåˆ†å±‚æ¶æ„+MVCæ¨¡å¼

**é¡¹ç›®åç§°**ï¼šäº‘åŸç”Ÿå¾®æœåŠ¡ç”µå•†å¹³å°  
**å½“å‰è¿­ä»£**ï¼šç¬¬ä¸€è¿­ä»£ï¼ˆæ•æ·å¼€å‘ï¼‰  
**æ ¸å¿ƒç”¨ä¾‹**ï¼šUC9ï¼ˆåˆ›å»ºè®¢å•ï¼‰ã€UC10ï¼ˆè®¢å•æ”¯ä»˜ï¼‰  
**æ¶æ„æ¨¡å¼**ï¼šåˆ†å±‚æ¶æ„ + MVCæ¨¡å¼  
**ç¼–å†™æ—¥æœŸ**ï¼š2025-11-18  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šV1.0

---

## ä¸€ã€ç±»çš„ç²¾åŒ–æ¦‚è¿°

### 1.1 ç²¾åŒ–ç›®çš„

åŸºäºå‰æœŸçš„ç±»åˆ†æï¼ˆ6.1.1ç±»çš„åˆ†æ.mdï¼‰ã€ç±»å›¾è®¾è®¡ï¼ˆ6.2ç±»å›¾è®¾è®¡.mdï¼‰å’Œä½“ç³»ç»“æ„å†³ç­–ï¼ˆ11.ä½“ç³»ç»“æ„å†³ç­–æè¿°æ–‡æ¡£.mdï¼‰ï¼Œå¯¹åŸæœ‰çš„17ä¸ªåˆ†æç±»è¿›è¡Œç²¾åŒ–ï¼Œä½¿å…¶ç¬¦åˆ**åˆ†å±‚æ¶æ„**å’Œ**MVCæ¨¡å¼**çš„è®¾è®¡è¦æ±‚ã€‚

### 1.2 ç²¾åŒ–ä¾æ®

- **å†³ç­–1**ï¼šè®¢å•æœåŠ¡å’Œæ”¯ä»˜æœåŠ¡é‡‡ç”¨åˆ†å±‚æ¶æ„é£æ ¼ï¼ˆè¡¨ç¤ºå±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ã€æ•°æ®è®¿é—®å±‚ï¼‰
- **å†³ç­–2**ï¼šè¡¨ç¤ºå±‚é‡‡ç”¨MVCæ¨¡å¼ï¼ˆController + DTOï¼Œæ— Viewå±‚ï¼‰
- **å†³ç­–9**ï¼šä½¿ç”¨MySQL + MyBatis-Plusè¿›è¡Œæ•°æ®æŒä¹…åŒ–

### 1.3 ç²¾åŒ–åŸåˆ™

1. **èŒè´£åˆ†ç¦»**ï¼šæ¯å±‚åªè´Ÿè´£ç‰¹å®šçš„èŒè´£ï¼Œä¸è·¨å±‚è°ƒç”¨
2. **ä¾èµ–æ–¹å‘**ï¼šä¸Šå±‚ä¾èµ–ä¸‹å±‚ï¼Œä¸‹å±‚ä¸ä¾èµ–ä¸Šå±‚
3. **æ¥å£éš”ç¦»**ï¼šé€šè¿‡æ¥å£å®šä¹‰å±‚é—´äº¤äº’
4. **æ•°æ®ä¼ è¾“**ï¼šä½¿ç”¨DTOåœ¨å±‚é—´ä¼ é€’æ•°æ®

---

## äºŒã€ç²¾åŒ–å‰åå¯¹æ¯”

### 2.1 åŸæœ‰åˆ†æç±»ï¼ˆ17ä¸ªï¼‰

| ç±»å‹ | æ•°é‡ | ç±»å |
|------|------|------|
| **å®ä½“ç±»** | 10 | User, Order, OrderItem, Product, ShoppingCart, CartItem, ShippingAddress, Inventory, PaymentOrder, PaymentRecord |
| **æšä¸¾ç±»** | 3 | OrderStatus, PaymentStatus, PaymentMethod |
| **æ§åˆ¶ç±»** | 4 | OrderService, InventoryService, PaymentService, PaymentCallbackHandler |
| **æ€»è®¡** | **17** | - |

### 2.2 ç²¾åŒ–åçš„ç±»ï¼ˆ31ä¸ªï¼‰

| ç±»å‹ | æ•°é‡ | æ–°å¢ç±» | è¯´æ˜ |
|------|------|--------|------|
| **è¾¹ç•Œç±»ï¼ˆBoundaryï¼‰** | 2 | OrderController, PaymentController | è¡¨ç¤ºå±‚ï¼Œå¤„ç†HTTPè¯·æ±‚ |
| **å®ä½“ç±»ï¼ˆEntityï¼‰** | 10 | ä¿æŒä¸å˜ | é¢†åŸŸå±‚ï¼Œä¸šåŠ¡å¯¹è±¡ |
| **æ§åˆ¶ç±»ï¼ˆControlï¼‰** | 4 | ä¿æŒä¸å˜ | ä¸šåŠ¡é€»è¾‘å±‚ï¼ŒService |
| **æ•°æ®è®¿é—®ç±»ï¼ˆRepositoryï¼‰** | 4 | OrderRepository, PaymentOrderRepository, PaymentRecordRepository, InventoryRepository | æ•°æ®è®¿é—®å±‚ |
| **DTOç±»** | 8 | CreateOrderRequest, CreateOrderResponse, OrderDTO, CreatePaymentRequest, PaymentResponse, PaymentStatusDTO, OrderItemDTO, PaymentPageData | æ•°æ®ä¼ è¾“å¯¹è±¡ |
| **æšä¸¾ç±»** | 3 | ä¿æŒä¸å˜ | çŠ¶æ€å’Œç±»å‹æšä¸¾ |
| **æ€»è®¡** | **31** | **æ–°å¢14ä¸ªç±»** | - |

---

## ä¸‰ã€åˆ†å±‚æ¶æ„è®¾è®¡

### 3.1 å››å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         è¡¨ç¤ºå±‚ (Presentation Layer)          â”‚
â”‚  - OrderController, PaymentController       â”‚
â”‚  - DTO: Request/Responseå¯¹è±¡                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer)      â”‚
â”‚  - OrderService, PaymentService             â”‚
â”‚  - InventoryService, PaymentCallbackHandler â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          é¢†åŸŸå±‚ (Domain Layer)               â”‚
â”‚  - Entity: Order, PaymentOrder, Inventory   â”‚
â”‚  - Enum: OrderStatus, PaymentStatus         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       æ•°æ®è®¿é—®å±‚ (Data Access Layer)         â”‚
â”‚  - Repository: OrderRepository, etc.        â”‚
â”‚  - MyBatis-Plus, MySQL                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å±‚é—´ä¾èµ–å…³ç³»

| è°ƒç”¨æ–¹ | è¢«è°ƒç”¨æ–¹ | ä¾èµ–ç±»å‹ | è¯´æ˜ |
|--------|---------|---------|------|
| Controller | Service | ä¾èµ–æ³¨å…¥ | è¡¨ç¤ºå±‚è°ƒç”¨ä¸šåŠ¡é€»è¾‘å±‚ |
| Service | Repository | ä¾èµ–æ³¨å…¥ | ä¸šåŠ¡é€»è¾‘å±‚è°ƒç”¨æ•°æ®è®¿é—®å±‚ |
| Service | Entity | åˆ›å»º/ä½¿ç”¨ | ä¸šåŠ¡é€»è¾‘å±‚æ“ä½œé¢†åŸŸå¯¹è±¡ |
| Repository | Entity | æŒä¹…åŒ– | æ•°æ®è®¿é—®å±‚æŒä¹…åŒ–å®ä½“ |
| Controller | DTO | ä½¿ç”¨ | è¡¨ç¤ºå±‚ä½¿ç”¨DTOä¼ è¾“æ•°æ® |

---

## å››ã€æ–°å¢ç±»è¯¦ç»†è¯´æ˜

### 4.1 è¾¹ç•Œç±»ï¼ˆBoundary/Controllerï¼‰

#### 4.1.1 OrderController

**èŒè´£**ï¼š
- å¤„ç†è®¢å•ç›¸å…³çš„HTTPè¯·æ±‚
- å‚æ•°éªŒè¯å’Œè½¬æ¢
- è°ƒç”¨OrderServiceå¤„ç†ä¸šåŠ¡é€»è¾‘
- è¿”å›JSONå“åº”

**ä¸»è¦æ–¹æ³•**ï¼š
```java
@RestController
@RequestMapping("/orders")
public class OrderController {
    @Autowired
    private OrderService orderService;
    
    // å‡†å¤‡è®¢å•ç¡®è®¤é¡µé¢æ•°æ®
    @GetMapping("/prepare")
    public ResponseEntity<OrderConfirmData> prepareOrder(
        @RequestParam Long userId,
        @RequestParam List<Long> cartItemIds
    );
    
    // åˆ›å»ºè®¢å•
    @PostMapping
    public ResponseEntity<CreateOrderResponse> createOrder(
        @RequestBody @Valid CreateOrderRequest request
    );
    
    // æŸ¥è¯¢è®¢å•è¯¦æƒ…
    @GetMapping("/{orderNumber}")
    public ResponseEntity<OrderDTO> getOrderDetail(
        @PathVariable String orderNumber
    );
    
    // æŸ¥è¯¢ç”¨æˆ·è®¢å•åˆ—è¡¨
    @GetMapping("/user/{userId}")
    public ResponseEntity<Page<OrderDTO>> getUserOrders(
        @PathVariable Long userId,
        @RequestParam(required = false) String status,
        @RequestParam(defaultValue = "1") int page,
        @RequestParam(defaultValue = "10") int size
    );
    
    // å–æ¶ˆè®¢å•
    @PutMapping("/{orderNumber}/cancel")
    public ResponseEntity<Void> cancelOrder(
        @PathVariable String orderNumber
    );
}
```

#### 4.1.2 PaymentController

**èŒè´£**ï¼š
- å¤„ç†æ”¯ä»˜ç›¸å…³çš„HTTPè¯·æ±‚
- å‚æ•°éªŒè¯å’Œè½¬æ¢
- è°ƒç”¨PaymentServiceå¤„ç†ä¸šåŠ¡é€»è¾‘
- è¿”å›JSONå“åº”

**ä¸»è¦æ–¹æ³•**ï¼š
```java
@RestController
@RequestMapping("/payments")
public class PaymentController {
    @Autowired
    private PaymentService paymentService;
    
    // è·å–æ”¯ä»˜é¡µé¢æ•°æ®
    @GetMapping("/page")
    public ResponseEntity<PaymentPageData> getPaymentPage(
        @RequestParam String orderNumber
    );
    
    // åˆ›å»ºæ”¯ä»˜è®¢å•
    @PostMapping
    public ResponseEntity<PaymentResponse> createPayment(
        @RequestBody @Valid CreatePaymentRequest request
    );
    
    // æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
    @GetMapping("/{paymentNumber}/status")
    public ResponseEntity<PaymentStatusDTO> queryPaymentStatus(
        @PathVariable String paymentNumber
    );
    
    // å¤„ç†æ”¯ä»˜å›è°ƒ
    @PostMapping("/callback")
    public ResponseEntity<Void> handleCallback(
        @RequestBody PaymentCallbackData callbackData
    );
}
```

---

### 4.2 æ•°æ®è®¿é—®ç±»ï¼ˆRepositoryï¼‰

#### 4.2.1 OrderRepository

**èŒè´£**ï¼š
- è®¢å•æ•°æ®çš„CRUDæ“ä½œ
- ä½¿ç”¨MyBatis-Plusçš„BaseMapperæ¥å£
- å°è£…æ•°æ®åº“è®¿é—®é€»è¾‘

**æ¥å£å®šä¹‰**ï¼š
```java
@Mapper
public interface OrderRepository extends BaseMapper<Order> {
    // ç»§æ‰¿BaseMapperçš„åŸºæœ¬CRUDæ–¹æ³•
    // - insert(Order order)
    // - selectById(Long id)
    // - updateById(Order order)
    // - deleteById(Long id)
    
    // è‡ªå®šä¹‰æŸ¥è¯¢æ–¹æ³•
    Order findByOrderNumber(String orderNumber);
    List<Order> findByUserId(Long userId);
    List<Order> findByUserIdAndStatus(Long userId, OrderStatus status);
    Page<Order> findByUserIdWithPage(Long userId, IPage<Order> page);
}
```

#### 4.2.2 PaymentOrderRepository

**èŒè´£**ï¼š
- æ”¯ä»˜è®¢å•æ•°æ®çš„CRUDæ“ä½œ
- ä½¿ç”¨MyBatis-Plusçš„BaseMapperæ¥å£

**æ¥å£å®šä¹‰**ï¼š
```java
@Mapper
public interface PaymentOrderRepository extends BaseMapper<PaymentOrder> {
    PaymentOrder findByPaymentNumber(String paymentNumber);
    PaymentOrder findByOrderId(Long orderId);
    List<PaymentOrder> findByStatus(PaymentStatus status);
}
```

#### 4.2.3 PaymentRecordRepository

**èŒè´£**ï¼š
- æ”¯ä»˜è®°å½•æ•°æ®çš„CRUDæ“ä½œ
- æ”¯æŒæ”¯ä»˜å†å²æŸ¥è¯¢

**æ¥å£å®šä¹‰**ï¼š
```java
@Mapper
public interface PaymentRecordRepository extends BaseMapper<PaymentRecord> {
    List<PaymentRecord> findByPaymentNumber(String paymentNumber);
    List<PaymentRecord> findByUserId(Long userId);
    List<PaymentRecord> findByOrderId(Long orderId);
    List<PaymentRecord> findByUserIdAndTimeRange(
        Long userId, 
        LocalDateTime startTime, 
        LocalDateTime endTime
    );
}
```

#### 4.2.4 InventoryRepository

**èŒè´£**ï¼š
- åº“å­˜æ•°æ®çš„CRUDæ“ä½œ
- æ”¯æŒä¹è§‚é”æ›´æ–°

**æ¥å£å®šä¹‰**ï¼š
```java
@Mapper
public interface InventoryRepository extends BaseMapper<Inventory> {
    Inventory findByProductId(Long productId);
    
    // ä½¿ç”¨ä¹è§‚é”æ›´æ–°åº“å­˜
    @Update("UPDATE inventory SET " +
            "available_stock = #{availableStock}, " +
            "locked_stock = #{lockedStock}, " +
            "version = version + 1 " +
            "WHERE product_id = #{productId} " +
            "AND version = #{version}")
    int updateWithOptimisticLock(Inventory inventory);
}
```

---

### 4.3 DTOç±»ï¼ˆData Transfer Objectï¼‰

#### 4.3.1 CreateOrderRequest

**èŒè´£**ï¼šå°è£…åˆ›å»ºè®¢å•çš„è¯·æ±‚å‚æ•°

```java
@Data
public class CreateOrderRequest {
    @NotNull(message = "ç”¨æˆ·IDä¸èƒ½ä¸ºç©º")
    private Long userId;
    
    @NotEmpty(message = "è´­ç‰©è½¦é¡¹ä¸èƒ½ä¸ºç©º")
    private List<Long> cartItemIds;
    
    @NotNull(message = "æ”¶è´§åœ°å€IDä¸èƒ½ä¸ºç©º")
    private Long addressId;
    
    @Size(max = 500, message = "å¤‡æ³¨ä¸èƒ½è¶…è¿‡500å­—ç¬¦")
    private String remark;
}
```

#### 4.3.2 CreateOrderResponse

**èŒè´£**ï¼šå°è£…åˆ›å»ºè®¢å•çš„å“åº”æ•°æ®

```java
@Data
public class CreateOrderResponse {
    private String orderNumber;
    private BigDecimal totalAmount;
    private LocalDateTime createTime;
    private LocalDateTime expireTime;
}
```

#### 4.3.3 OrderDTO

**èŒè´£**ï¼šå°è£…è®¢å•è¯¦æƒ…æ•°æ®

```java
@Data
public class OrderDTO {
    private String orderNumber;
    private Long userId;
    private BigDecimal totalAmount;
    private String status;
    private List<OrderItemDTO> items;
    private String recipientName;
    private String recipientPhone;
    private String shippingAddress;
    private LocalDateTime createTime;
    private LocalDateTime payTime;
}
```

#### 4.3.4 CreatePaymentRequest

**èŒè´£**ï¼šå°è£…åˆ›å»ºæ”¯ä»˜çš„è¯·æ±‚å‚æ•°

```java
@Data
public class CreatePaymentRequest {
    @NotBlank(message = "è®¢å•å·ä¸èƒ½ä¸ºç©º")
    private String orderNumber;
    
    @NotBlank(message = "æ”¯ä»˜æ–¹å¼ä¸èƒ½ä¸ºç©º")
    private String paymentMethod; // ALIPAY, WECHAT, MOCK
}
```

#### 4.3.5 PaymentResponse

**èŒè´£**ï¼šå°è£…æ”¯ä»˜å“åº”æ•°æ®

```java
@Data
public class PaymentResponse {
    private String paymentNumber;
    private BigDecimal amount;
    private String status;
    private LocalDateTime createTime;
}
```

#### 4.3.6 PaymentStatusDTO

**èŒè´£**ï¼šå°è£…æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢ç»“æœ

```java
@Data
public class PaymentStatusDTO {
    private String paymentNumber;
    private String status; // PENDING, SUCCESS, FAILED
    private LocalDateTime payTime;
}
```

---

## äº”ã€ç²¾åŒ–åçš„ç±»å›¾

### 5.1 PlantUMLæ–‡ä»¶

**æ–‡ä»¶è·¯å¾„**ï¼š`out/ç±»å›¾UML/RefinedClassDiagram/RefinedClassDiagram.png`

**ç±»å›¾å±•ç¤º**ï¼š

![ç²¾åŒ–åçš„ç±»å›¾](out/ç±»å›¾UML/RefinedClassDiagram/RefinedClassDiagram.png)

> ğŸ’¡ **PlantUMLæºæ–‡ä»¶**ï¼š[`ç±»å›¾UML/RefinedClassDiagram.puml`](ç±»å›¾UML/RefinedClassDiagram.puml)

**ç±»å›¾ç‰¹ç‚¹**ï¼š
1. âœ… æ¸…æ™°å±•ç¤ºå››å±‚æ¶æ„ï¼ˆè¡¨ç¤ºå±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ã€é¢†åŸŸå±‚ã€æ•°æ®è®¿é—®å±‚ï¼‰
2. âœ… ä½¿ç”¨ä¸åŒé¢œè‰²åŒºåˆ†ä¸åŒç±»å‹çš„ç±»
3. âœ… æ ‡æ³¨ç±»çš„æ„é€ å‹ï¼ˆ<<Boundary>>, <<Control>>, <<Entity>>, <<Repository>>, <<DTO>>ï¼‰
4. âœ… å±•ç¤ºå±‚é—´ä¾èµ–å…³ç³»
5. âœ… åŒ…å«æ³¨é‡Šè¯´æ˜æ¯å±‚çš„èŒè´£

### 5.2 ç±»ç»Ÿè®¡

| å±‚æ¬¡ | ç±»å‹ | æ•°é‡ | ç±»å |
|------|------|------|------|
| **è¡¨ç¤ºå±‚** | Boundary | 2 | OrderController, PaymentController |
| **è¡¨ç¤ºå±‚** | DTO | 8 | CreateOrderRequest, CreateOrderResponse, OrderDTO, CreatePaymentRequest, PaymentResponse, PaymentStatusDTO, OrderItemDTO, PaymentPageData |
| **ä¸šåŠ¡é€»è¾‘å±‚** | Control | 4 | OrderService, InventoryService, PaymentService, PaymentCallbackHandler |
| **é¢†åŸŸå±‚** | Entity | 10 | User, Order, OrderItem, Product, ShoppingCart, CartItem, ShippingAddress, Inventory, PaymentOrder, PaymentRecord |
| **é¢†åŸŸå±‚** | Enum | 3 | OrderStatus, PaymentStatus, PaymentMethod |
| **æ•°æ®è®¿é—®å±‚** | Repository | 4 | OrderRepository, PaymentOrderRepository, PaymentRecordRepository, InventoryRepository |
| **æ€»è®¡** | - | **31** | - |

---

## å…­ã€ç²¾åŒ–åçš„é¡ºåºå›¾

### 6.1 UC9åˆ›å»ºè®¢å•é¡ºåºå›¾

**æ–‡ä»¶è·¯å¾„**ï¼š`out/ç±»å›¾UML/UC9_Refined_Sequence/UC9_Refined_Sequence.png`

**é¡ºåºå›¾å±•ç¤º**ï¼š

![UC9åˆ›å»ºè®¢å•é¡ºåºå›¾](out/ç±»å›¾UML/UC9_Refined_Sequence/UC9_Refined_Sequence.png)

> ğŸ’¡ **PlantUMLæºæ–‡ä»¶**ï¼š[`ç±»å›¾UML/UC9_Refined_Sequence.puml`](ç±»å›¾UML/UC9_Refined_Sequence.puml)

**é¡ºåºå›¾ç‰¹ç‚¹**ï¼š
1. âœ… å±•ç¤ºå®Œæ•´çš„åˆ†å±‚è°ƒç”¨æµç¨‹ï¼ˆController â†’ Service â†’ Repository â†’ Databaseï¼‰
2. âœ… åŒ…å«DTOçš„åˆ›å»ºå’Œä½¿ç”¨
3. âœ… å±•ç¤ºæ•°æ®åº“äº¤äº’ï¼ˆSQLè¯­å¥ï¼‰
4. âœ… åŒ…å«å¼‚å¸¸å¤„ç†æµç¨‹ï¼ˆåº“å­˜ä¸è¶³ã€åº“å­˜é”å®šå¤±è´¥ï¼‰
5. âœ… å±•ç¤ºä¹è§‚é”çš„ä½¿ç”¨
6. âœ… æ ‡æ³¨Seataåˆ†å¸ƒå¼äº‹åŠ¡

**ä¸»è¦æµç¨‹**ï¼š
1. ç”¨æˆ·æäº¤è®¢å• â†’ OrderControlleræ¥æ”¶è¯·æ±‚
2. Controlleråˆ›å»ºCreateOrderRequest DTO
3. Controllerè°ƒç”¨OrderService.createOrder()
4. OrderServiceè°ƒç”¨InventoryServiceæ ¡éªŒåº“å­˜
5. InventoryServiceé€šè¿‡InventoryRepositoryæŸ¥è¯¢æ•°æ®åº“
6. OrderServiceåˆ›å»ºOrderå’ŒOrderItemå®ä½“
7. OrderServiceè°ƒç”¨InventoryServiceé¢„æ‰£åº“å­˜ï¼ˆä¹è§‚é”ï¼‰
8. OrderServiceé€šè¿‡OrderRepositoryä¿å­˜è®¢å•åˆ°æ•°æ®åº“
9. OrderServiceåˆ›å»ºCreateOrderResponse DTO
10. Controllerè¿”å›JSONå“åº”ç»™ç”¨æˆ·

### 6.2 UC10è®¢å•æ”¯ä»˜é¡ºåºå›¾

**æ–‡ä»¶è·¯å¾„**ï¼š`out/ç±»å›¾UML/UC10_Refined_Sequence/UC10_Refined_Sequence.png`

**é¡ºåºå›¾å±•ç¤º**ï¼š

![UC10è®¢å•æ”¯ä»˜é¡ºåºå›¾](out/ç±»å›¾UML/UC10_Refined_Sequence/UC10_Refined_Sequence.png)

> ğŸ’¡ **PlantUMLæºæ–‡ä»¶**ï¼š[`ç±»å›¾UML/UC10_Refined_Sequence.puml`](ç±»å›¾UML/UC10_Refined_Sequence.puml)

**é¡ºåºå›¾ç‰¹ç‚¹**ï¼š
1. âœ… å±•ç¤ºå®Œæ•´çš„æ”¯ä»˜æµç¨‹ï¼ˆåˆ›å»ºæ”¯ä»˜è®¢å• â†’ è°ƒç”¨æ”¯ä»˜ç½‘å…³ â†’ å¤„ç†å›è°ƒï¼‰
2. âœ… å±•ç¤ºRabbitMQå¼‚æ­¥æ¶ˆæ¯ä¼ é€’
3. âœ… å±•ç¤ºæ”¯ä»˜æˆåŠŸå’Œå¤±è´¥ä¸¤ç§åœºæ™¯
4. âœ… å±•ç¤ºè®¢å•æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯çš„æµç¨‹
5. âœ… å±•ç¤ºåº“å­˜æ‰£å‡å’Œé‡Šæ”¾çš„é€»è¾‘
6. âœ… åŒ…å«æ•°æ®åº“äº¤äº’

**ä¸»è¦æµç¨‹**ï¼š
1. ç”¨æˆ·è¿›å…¥æ”¯ä»˜é¡µé¢ â†’ PaymentControllerè·å–æ”¯ä»˜ä¿¡æ¯
2. ç”¨æˆ·ç¡®è®¤æ”¯ä»˜ â†’ PaymentControlleræ¥æ”¶è¯·æ±‚
3. Controlleråˆ›å»ºCreatePaymentRequest DTO
4. Controllerè°ƒç”¨PaymentService.createPaymentOrder()
5. PaymentServiceåˆ›å»ºPaymentOrderå®ä½“å¹¶ä¿å­˜åˆ°æ•°æ®åº“
6. PaymentServiceè°ƒç”¨PaymentGatewayæ¨¡æ‹Ÿæ”¯ä»˜
7. PaymentServiceè°ƒç”¨PaymentCallbackHandlerå¤„ç†å›è°ƒ
8. **æ”¯ä»˜æˆåŠŸåˆ†æ”¯**ï¼š
   - CallbackHandleræ›´æ–°PaymentOrderçŠ¶æ€
   - CallbackHandlerå‘é€æ¶ˆæ¯åˆ°RabbitMQ
   - OrderServiceæ¶ˆè´¹æ¶ˆæ¯ï¼Œæ›´æ–°OrderçŠ¶æ€
   - OrderServiceè°ƒç”¨InventoryServiceæ‰£å‡åº“å­˜
   - OrderServiceæ¸…ç©ºè´­ç‰©è½¦
   - CallbackHandleråˆ›å»ºPaymentRecord
9. **æ”¯ä»˜å¤±è´¥åˆ†æ”¯**ï¼š
   - CallbackHandleræ›´æ–°PaymentOrderçŠ¶æ€ä¸ºFAILED
   - CallbackHandlerè°ƒç”¨OrderServiceå–æ¶ˆè®¢å•
   - CallbackHandlerè°ƒç”¨InventoryServiceé‡Šæ”¾åº“å­˜
   - CallbackHandleråˆ›å»ºPaymentRecord

---

## ä¸ƒã€ç²¾åŒ–è®¾è®¡çš„ä¼˜åŠ¿

### 7.1 èŒè´£æ¸…æ™°

| å±‚æ¬¡ | èŒè´£ | ä¼˜åŠ¿ |
|------|------|------|
| **è¡¨ç¤ºå±‚** | å¤„ç†HTTPè¯·æ±‚ï¼Œå‚æ•°éªŒè¯ï¼Œè¿”å›å“åº” | æ˜“äºæµ‹è¯•ï¼Œå¯ä»¥mock Serviceå±‚ |
| **ä¸šåŠ¡é€»è¾‘å±‚** | ä¸šåŠ¡è§„åˆ™ï¼Œäº‹åŠ¡ç®¡ç†ï¼ŒæœåŠ¡ç¼–æ’ | ä¸šåŠ¡é€»è¾‘é›†ä¸­ï¼Œæ˜“äºç»´æŠ¤ |
| **é¢†åŸŸå±‚** | é¢†åŸŸå¯¹è±¡ï¼Œä¸šåŠ¡è§„åˆ™ | ç¬¦åˆDDDæ€æƒ³ï¼Œä¸šåŠ¡è¯­ä¹‰æ¸…æ™° |
| **æ•°æ®è®¿é—®å±‚** | æ•°æ®æŒä¹…åŒ–ï¼ŒCRUDæ“ä½œ | æ•°æ®è®¿é—®é€»è¾‘å°è£…ï¼Œæ˜“äºåˆ‡æ¢ORMæ¡†æ¶ |

### 7.2 æ˜“äºæµ‹è¯•

```java
// å•å…ƒæµ‹è¯•ç¤ºä¾‹ï¼šæµ‹è¯•OrderService
@SpringBootTest
public class OrderServiceTest {
    @Autowired
    private OrderService orderService;
    
    @MockBean
    private OrderRepository orderRepository;
    
    @MockBean
    private InventoryService inventoryService;
    
    @Test
    public void testCreateOrder() {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        CreateOrderRequest request = new CreateOrderRequest();
        request.setUserId(1L);
        request.setCartItemIds(Arrays.asList(1L, 2L));
        request.setAddressId(1L);
        
        // Mockä¾èµ–
        when(inventoryService.batchCheckStock(any()))
            .thenReturn(Collections.emptyMap());
        when(orderRepository.save(any()))
            .thenReturn(mockOrder);
        
        // æ‰§è¡Œæµ‹è¯•
        Order order = orderService.createOrder(request);
        
        // éªŒè¯ç»“æœ
        assertNotNull(order);
        assertEquals("PENDING_PAYMENT", order.getStatus());
    }
}
```

### 7.3 æ˜“äºæ‰©å±•

**åœºæ™¯1ï¼šæ–°å¢æ”¯ä»˜æ–¹å¼**
- åªéœ€åœ¨PaymentMethodæšä¸¾ä¸­æ·»åŠ æ–°çš„æ”¯ä»˜æ–¹å¼
- åœ¨PaymentServiceä¸­æ·»åŠ å¯¹åº”çš„å¤„ç†é€»è¾‘
- ä¸å½±å“å…¶ä»–å±‚

**åœºæ™¯2ï¼šåˆ‡æ¢ORMæ¡†æ¶**
- åªéœ€ä¿®æ”¹Repositoryå±‚çš„å®ç°
- ä¸å½±å“Serviceå±‚å’ŒControllerå±‚

**åœºæ™¯3ï¼šæ–°å¢è®¢å•çŠ¶æ€**
- åªéœ€åœ¨OrderStatusæšä¸¾ä¸­æ·»åŠ æ–°çŠ¶æ€
- åœ¨OrderServiceä¸­æ·»åŠ çŠ¶æ€è½¬æ¢é€»è¾‘
- ä¸å½±å“å…¶ä»–å±‚

### 7.4 ç¬¦åˆSOLIDåŸåˆ™

| åŸåˆ™ | ä½“ç° |
|------|------|
| **å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰** | æ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªèŒè´£ï¼ˆControllerå¤„ç†è¯·æ±‚ï¼ŒServiceå¤„ç†ä¸šåŠ¡ï¼ŒRepositoryå¤„ç†æ•°æ®ï¼‰ |
| **å¼€é—­åŸåˆ™ï¼ˆOCPï¼‰** | å¯¹æ‰©å±•å¼€æ”¾ï¼ˆå¯ä»¥æ–°å¢Serviceï¼‰ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼ˆä¸å½±å“ç°æœ‰ä»£ç ï¼‰ |
| **é‡Œæ°æ›¿æ¢åŸåˆ™ï¼ˆLSPï¼‰** | Repositoryæ¥å£å¯ä»¥æœ‰å¤šç§å®ç°ï¼ˆMyBatis-Plusã€JPAï¼‰ |
| **æ¥å£éš”ç¦»åŸåˆ™ï¼ˆISPï¼‰** | Repositoryæ¥å£åªå®šä¹‰å¿…è¦çš„æ–¹æ³• |
| **ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰** | ä¸Šå±‚ä¾èµ–æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç° |

---

## å…«ã€ä¸åŸæœ‰ç±»å›¾çš„å¯¹æ¯”

### 8.1 åŸæœ‰ç±»å›¾ï¼ˆ6.2ç±»å›¾è®¾è®¡.mdï¼‰

**ç‰¹ç‚¹**ï¼š
- 17ä¸ªç±»ï¼Œä¸»è¦å…³æ³¨é¢†åŸŸæ¨¡å‹
- æ²¡æœ‰æ˜ç¡®çš„åˆ†å±‚ç»“æ„
- ç¼ºå°‘Controllerå’ŒRepository
- ç¼ºå°‘DTO

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€æ±‚åˆ†æé˜¶æ®µ
- ç†è§£ä¸šåŠ¡é¢†åŸŸæ¨¡å‹
- è¯†åˆ«æ ¸å¿ƒå®ä½“å’Œå…³ç³»

### 8.2 ç²¾åŒ–åçš„ç±»å›¾

**ç‰¹ç‚¹**ï¼š
- 31ä¸ªç±»ï¼Œå®Œæ•´çš„åˆ†å±‚æ¶æ„
- æ¸…æ™°çš„å±‚æ¬¡ç»“æ„ï¼ˆè¡¨ç¤ºå±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ã€é¢†åŸŸå±‚ã€æ•°æ®è®¿é—®å±‚ï¼‰
- åŒ…å«Controllerã€Repositoryã€DTO
- ç¬¦åˆMVCæ¨¡å¼

**é€‚ç”¨åœºæ™¯**ï¼š
- è¯¦ç»†è®¾è®¡é˜¶æ®µ
- æŒ‡å¯¼ç¼–ç å®ç°
- ä»£ç ç”Ÿæˆ
- æ¶æ„è¯„å®¡

---

## ä¹ã€å®ç°å»ºè®®

### 9.1 å¼€å‘é¡ºåº

1. **ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºå®ä½“ç±»å’Œæšä¸¾ç±»**ï¼ˆé¢†åŸŸå±‚ï¼‰
   - Order, OrderItem, PaymentOrder, PaymentRecord, Inventory
   - OrderStatus, PaymentStatus, PaymentMethod

2. **ç¬¬äºŒæ­¥ï¼šåˆ›å»ºRepositoryæ¥å£**ï¼ˆæ•°æ®è®¿é—®å±‚ï¼‰
   - OrderRepository, PaymentOrderRepository, PaymentRecordRepository, InventoryRepository
   - é…ç½®MyBatis-Plus

3. **ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºServiceç±»**ï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰
   - OrderService, PaymentService, InventoryService, PaymentCallbackHandler
   - å®ç°ä¸šåŠ¡é€»è¾‘

4. **ç¬¬å››æ­¥ï¼šåˆ›å»ºDTOç±»**ï¼ˆè¡¨ç¤ºå±‚ï¼‰
   - CreateOrderRequest, CreateOrderResponse, OrderDTO
   - CreatePaymentRequest, PaymentResponse, PaymentStatusDTO

5. **ç¬¬äº”æ­¥ï¼šåˆ›å»ºControllerç±»**ï¼ˆè¡¨ç¤ºå±‚ï¼‰
   - OrderController, PaymentController
   - å®ç°RESTful API

6. **ç¬¬å…­æ­¥ï¼šé›†æˆæµ‹è¯•**
   - å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•
   - ç«¯åˆ°ç«¯æµ‹è¯•

### 9.2 æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ |
|------|---------|------|
| å¼€å‘è¯­è¨€ | Java | 17+ |
| Webæ¡†æ¶ | Spring Boot | 3.x |
| MVCæ¡†æ¶ | Spring MVC | - |
| ORMæ¡†æ¶ | MyBatis-Plus | 3.x |
| æ•°æ®åº“ | MySQL | 8.0 |
| å‚æ•°éªŒè¯ | Hibernate Validator | - |
| JSONåºåˆ—åŒ– | Jackson | - |
| APIæ–‡æ¡£ | Swagger/OpenAPI | 3.x |

### 9.3 ä»£ç è§„èŒƒ

1. **å‘½åè§„èŒƒ**ï¼š
   - Controllerç±»ï¼šä»¥Controllerç»“å°¾
   - Serviceç±»ï¼šä»¥Serviceç»“å°¾
   - Repositoryæ¥å£ï¼šä»¥Repositoryç»“å°¾
   - DTOç±»ï¼šä»¥Request/Response/DTOç»“å°¾

2. **åŒ…ç»“æ„**ï¼š
```
com.ecommerce.order
â”œâ”€â”€ controller          # è¡¨ç¤ºå±‚
â”‚   â”œâ”€â”€ OrderController
â”‚   â””â”€â”€ dto
â”‚       â”œâ”€â”€ CreateOrderRequest
â”‚       â””â”€â”€ CreateOrderResponse
â”œâ”€â”€ service             # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ OrderService
â”‚   â””â”€â”€ InventoryService
â”œâ”€â”€ domain              # é¢†åŸŸå±‚
â”‚   â”œâ”€â”€ entity
â”‚   â”‚   â”œâ”€â”€ Order
â”‚   â”‚   â””â”€â”€ OrderItem
â”‚   â””â”€â”€ enums
â”‚       â””â”€â”€ OrderStatus
â””â”€â”€ repository          # æ•°æ®è®¿é—®å±‚
    â””â”€â”€ OrderRepository
```

3. **æ³¨è§£ä½¿ç”¨**ï¼š
   - Controllerï¼š`@RestController`, `@RequestMapping`
   - Serviceï¼š`@Service`, `@Transactional`
   - Repositoryï¼š`@Mapper`
   - DTOï¼š`@Data`, `@NotNull`, `@Valid`

---

## åã€æ€»ç»“

### 10.1 ç²¾åŒ–æˆæœ

âœ… **å®Œæˆäº†ç±»çš„ç²¾åŒ–å·¥ä½œ**ï¼š
- ä»17ä¸ªåˆ†æç±»æ‰©å±•åˆ°31ä¸ªè®¾è®¡ç±»
- æ–°å¢14ä¸ªç±»ï¼ˆ2ä¸ªControllerã€4ä¸ªRepositoryã€8ä¸ªDTOï¼‰
- å½¢æˆå®Œæ•´çš„å››å±‚æ¶æ„

âœ… **ç”Ÿæˆäº†ç²¾åŒ–åçš„ç±»å›¾**ï¼š
- æ–‡ä»¶ï¼š`ç±»å›¾UML/RefinedClassDiagram.puml`
- æ¸…æ™°å±•ç¤ºåˆ†å±‚æ¶æ„å’Œç±»é—´å…³ç³»
- ä½¿ç”¨ä¸åŒé¢œè‰²å’Œæ„é€ å‹åŒºåˆ†ç±»å‹

âœ… **ç”Ÿæˆäº†ç²¾åŒ–åçš„é¡ºåºå›¾**ï¼š
- UC9ï¼š`ç±»å›¾UML/UC9_Refined_Sequence.puml`
- UC10ï¼š`ç±»å›¾UML/UC10_Refined_Sequence.puml`
- å±•ç¤ºå®Œæ•´çš„åˆ†å±‚è°ƒç”¨æµç¨‹
- åŒ…å«æ•°æ®åº“äº¤äº’å’Œå¼‚æ­¥æ¶ˆæ¯ä¼ é€’

### 10.2 è®¾è®¡è´¨é‡

| è´¨é‡å±æ€§ | è¯„ä»· | è¯´æ˜ |
|---------|------|------|
| **å¯ç»´æŠ¤æ€§** | â­â­â­â­â­ | èŒè´£æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œä¿®æ”¹ |
| **å¯æµ‹è¯•æ€§** | â­â­â­â­â­ | æ¯å±‚å¯ä»¥ç‹¬ç«‹æµ‹è¯•ï¼Œæ˜“äºmock |
| **å¯æ‰©å±•æ€§** | â­â­â­â­â­ | ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œæ˜“äºæ‰©å±• |
| **å¯å¤ç”¨æ€§** | â­â­â­â­ | Serviceå’ŒRepositoryå¯ä»¥å¤ç”¨ |
| **æ€§èƒ½** | â­â­â­â­ | åˆ†å±‚è°ƒç”¨æœ‰ä¸€å®šå¼€é”€ï¼Œä½†å¯æ¥å— |

### 10.3 ä¸‹ä¸€æ­¥å·¥ä½œ

1. âœ… ç±»çš„ç²¾åŒ–è®¾è®¡å·²å®Œæˆ
2. â­ï¸ åŸºäºç²¾åŒ–åçš„ç±»å›¾è¿›è¡Œç¼–ç å®ç°
3. â­ï¸ ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
4. â­ï¸ éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒè¿›è¡Œè”è°ƒæµ‹è¯•
5. â­ï¸ æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šV1.0  
**æ–‡æ¡£çŠ¶æ€**ï¼šç±»çš„ç²¾åŒ–è®¾è®¡å·²å®Œæˆ  
**å·¥ä½œäº§å“**ï¼š
- ç²¾åŒ–åçš„ç±»å›¾ï¼š`ç±»å›¾UML/RefinedClassDiagram.puml`
- UC9ç²¾åŒ–é¡ºåºå›¾ï¼š`ç±»å›¾UML/UC9_Refined_Sequence.puml`
- UC10ç²¾åŒ–é¡ºåºå›¾ï¼š`ç±»å›¾UML/UC10_Refined_Sequence.puml`

