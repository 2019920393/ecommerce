@startuml ComponentInterface_Diagram

!theme plain

' ============================
' 中文字体配置
' ============================
skinparam defaultFontName "Microsoft YaHei, SimHei, Arial Unicode MS"
skinparam defaultFontSize 11

skinparam componentStyle rectangle
skinparam linetype ortho

title 构件接口设计图 - UC9创建订单 & UC10订单支付

' ============================
' 订单构件
' ============================
package "订单构件 (Order Component)" {
    
    ' 表示层
    component "OrderController" as OC {
        portin "POST /orders" as OC_Create
        portin "GET /orders/{orderNumber}" as OC_Get
        portin "PUT /orders/{orderNumber}/cancel" as OC_Cancel
    }
    
    ' 业务逻辑层
    component "OrderService" as OS {
        portin "createOrder()" as OS_Create
        portin "getOrderDetail()" as OS_Get
        portin "updateOrderStatus()" as OS_Update
        portin "cancelOrder()" as OS_Cancel
        portin "handlePaymentSuccess()" as OS_Handle
    }
    
    ' 数据访问层
    component "OrderRepository" as OR {
        portin "save()" as OR_Save
        portin "findByOrderNumber()" as OR_Find
        portin "update()" as OR_Update
        portin "findExpiredOrders()" as OR_Expired
    }
    
    OC --> OS : 调用
    OS --> OR : 调用
}

' ============================
' 支付构件
' ============================
package "支付构件 (Payment Component)" {
    
    ' 表示层
    component "PaymentController" as PC {
        portin "POST /payments" as PC_Create
        portin "POST /payments/callback/alipay" as PC_Alipay
        portin "POST /payments/callback/wechat" as PC_Wechat
        portin "GET /payments/{paymentNumber}/status" as PC_Status
    }
    
    ' 业务逻辑层
    component "PaymentService" as PS {
        portin "createPaymentOrder()" as PS_Create
        portin "getPaymentStatus()" as PS_Status
        portin "handlePaymentCallback()" as PS_Callback
    }
    
    component "PaymentCallbackHandler" as PCH {
        portin "handlePaymentSuccess()" as PCH_Success
        portin "handlePaymentFailed()" as PCH_Failed
        portin "verifySignature()" as PCH_Verify
    }
    
    ' 数据访问层
    component "PaymentOrderRepository" as PR {
        portin "save()" as PR_Save
        portin "findByPaymentNumber()" as PR_Find
        portin "update()" as PR_Update
        portin "findExpiredPayments()" as PR_Expired
    }
    
    component "PaymentRecordRepository" as PRR {
        portin "save()" as PRR_Save
        portin "findByPaymentNumber()" as PRR_Find
    }
    
    PC --> PS : 调用
    PS --> PCH : 调用
    PS --> PR : 调用
    PCH --> PRR : 调用
}

' ============================
' 库存构件
' ============================
package "库存构件 (Inventory Component)" {
    
    ' 业务逻辑层
    component "InventoryService" as IS {
        portin "batchCheckStock()" as IS_Check
        portin "lockStock()" as IS_Lock
        portin "deductStock()" as IS_Deduct
        portin "releaseStock()" as IS_Release
    }
    
    ' 数据访问层
    component "InventoryRepository" as IR {
        portin "findByProductId()" as IR_Find
        portin "updateWithOptimisticLock()" as IR_Update
        portin "findByProductIds()" as IR_Batch
    }
    
    IS --> IR : 调用
}

' ============================
' 外部系统
' ============================
cloud "外部系统" {
    component "支付宝网关" as Alipay {
        portin "processPayment()" as Alipay_Pay
        portout "paymentCallback()" as Alipay_Callback
    }
    
    component "微信支付网关" as Wechat {
        portin "processPayment()" as Wechat_Pay
        portout "paymentCallback()" as Wechat_Callback
    }
    
    component "购物车服务" as Cart {
        portout "getCartItems()" as Cart_Get
        portin "clearPaidItems()" as Cart_Clear
    }
    
    component "商品服务" as Product {
        portout "getProductDetails()" as Product_Get
    }
    
    component "用户服务" as User {
        portout "getUserAddresses()" as User_Get
    }
}

' ============================
' 消息队列
' ============================
queue "RabbitMQ" as MQ {
    portin "publish(payment.success)" as MQ_Pub
    portout "consume(payment.success.queue)" as MQ_Sub
}

' ============================
' 数据库
' ============================
database "MySQL" {
    component "order_db" as OrderDB {
        portin "orders表" as OrderDB_Orders
        portin "order_items表" as OrderDB_Items
    }
    
    component "payment_db" as PaymentDB {
        portin "payment_orders表" as PaymentDB_Orders
        portin "payment_records表" as PaymentDB_Records
    }
    
    component "product_db" as ProductDB {
        portin "inventory表" as ProductDB_Inventory
    }
}

' ============================
' 构件间接口调用关系
' ============================

' 订单服务调用库存服务
OS ..> IS : <<需要>>\nbatchCheckStock()\nlockStock()

' 订单服务调用外部服务
OS ..> Cart_Get : <<需要>>\ngetCartItems()
OS ..> Product_Get : <<需要>>\ngetProductDetails()
OS ..> User_Get : <<需要>>\ngetUserAddresses()
OS ..> Cart_Clear : <<需要>>\nclearPaidItems()

' 支付服务调用订单服务
PS ..> OS_Get : <<需要>>\ngetOrderDetail()
PCH ..> OS_Update : <<需要>>\nupdateOrderStatus()
PCH ..> OS_Cancel : <<需要>>\ncancelOrder()

' 支付服务调用库存服务
PCH ..> IS_Deduct : <<需要>>\ndeductStock()
PCH ..> IS_Release : <<需要>>\nreleaseStock()

' 支付服务调用第三方支付
PS ..> Alipay_Pay : <<需要>>\nprocessPayment()
PS ..> Wechat_Pay : <<需要>>\nprocessPayment()

' 第三方支付回调
Alipay_Callback ..> PC_Alipay : <<回调>>
Wechat_Callback ..> PC_Wechat : <<回调>>

' 消息队列
PCH ..> MQ_Pub : <<发布>>\npayment.success
MQ_Sub ..> OS_Handle : <<消费>>

' 数据访问层访问数据库
OR --> OrderDB_Orders : SQL
OR --> OrderDB_Items : SQL
PR --> PaymentDB_Orders : SQL
PRR --> PaymentDB_Records : SQL
IR --> ProductDB_Inventory : SQL

' ============================
' 图例
' ============================
legend right
    |= 符号 |= 说明 |
    | ──> | 同步调用 |
    | ..> | 异步调用/需求接口 |
    | <<需要>> | 需求接口 |
    | <<回调>> | 回调接口 |
    | <<发布>> | 消息发布 |
    | <<消费>> | 消息消费 |
endlegend

note right of OC
    **表示层接口**
    - RESTful API
    - 参数验证
    - 异常处理
    - 响应封装
end note

note right of OS
    **业务逻辑层接口**
    - 业务规则
    - 事务管理
    - 分布式事务
    - 异步消息
end note

note right of OR
    **数据访问层接口**
    - CRUD操作
    - 乐观锁
    - 分页查询
    - 批量操作
end note

@enduml