@startuml OrderComponent_HandlePaymentSuccess_Activity

!theme plain

' ============================
' 中文字体配置
' ============================
skinparam defaultFontName "Microsoft YaHei, SimHei, Arial Unicode MS"
skinparam defaultFontSize 11

title 订单构件 - 处理支付成功活动图

start

:从RabbitMQ接收支付成功消息;
note right
  消息内容：
  - paymentNumber: 支付流水号
  - orderNumber: 订单号
  - userId: 用户ID
  - amount: 支付金额
  - paymentMethod: 支付方式
  - payTime: 支付时间
end note

:解析消息内容;

:根据订单号查询订单;

if (订单存在?) then (是)
  
  if (订单状态为PENDING_PAYMENT?) then (是)
    
    :更新订单状态为PENDING_SHIPMENT;
    :设置支付时间;
    
    :调用InventoryService扣减库存;
    note right
      遍历订单商品：
      total_stock -= locked_quantity
      locked_stock -= locked_quantity
    end note
    
    if (库存扣减成功?) then (是)
      
      :调用CartService清空购物车;
      note right
        删除已支付的购物车项
      end note
      
      :保存订单到数据库;
      
      :发送订单状态变更通知;
      note right
        通知用户订单已支付
        通知仓库准备发货
      end note
      
      :ACK消息（消费成功）;
      
      #4CAF50:处理成功;
      stop
      
    else (否)
      :记录错误日志;
      :NACK消息（重新入队）;
      
      #FF6B6B:库存扣减失败\n消息重新入队;
      stop
    endif
    
  else (否)
    :记录警告日志;
    note right
      订单状态不是待支付
      可能是重复消息
    end note
    
    :ACK消息（幂等处理）;
    
    #FFA726:订单状态异常\n幂等处理;
    stop
  endif
  
else (否)
  :记录错误日志;
  :ACK消息（避免重复消费）;
  
  #FF6B6B:订单不存在;
  stop
endif

@enduml